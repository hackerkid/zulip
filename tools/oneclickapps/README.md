# Oneclick App release automation

This directory contains scripts for automating the release of one click apps.

## DigitalOcean 1-Click Application
`prepare_digital_ocean_one_click_app_release.py` creates the image of DigitalOcean 1-Click app from the latest Zulip release. It will also
create a test droplet from the image and send the image and droplet
details to a pre-configured Zulip stream. Anyone who is a member of
Zulip DigitalOcean team can SSH into the created droplet for testing.

### Running as GitHub action

Set the following secrets in your GitHub repository. These are passed as environment variables to the GitHub action.

* `DIGITALOCEAN_API_KEY` - DigitalOcean API KEY used for creating droplets, snapshots etc.
* `ZULIP_API_KEY` - The API key of the Zulip Bot used for sending messages.
* `ZULIP_EMAIL` - The email of the Zulip bot.
* `ZULIP_SITE` - The URL of the Zulip realm.

Pass the following as environment variables in 
`.github/workflows/update-oneclick-apps.yml`.
*  `PYTHON_DIGITALOCEAN_REQUEST_TIMEOUT_SEC` -  This configures the maximum number of seconds to wait before the requests made by `python-digitalocean` timeout. If not configured, it's common for the requests to take 20+ minutes before getting timed out.

`prepare_digital_ocean_one_click_app_release.py` would be invoked automatically as a GitHub action during the release.

### Verifying the 1-Click App image
* SSH into the test droplet by following the instructions in the Zulip message sent by the action.
* After SSHing to the test droplet, exit the installer and run the following script.
https://raw.githubusercontent.com/digitalocean/marketplace-partners/master/scripts/img_check.sh
* If there are no errors (you can ignore most of the warnings), exit the SSH connection and reconnect. Enter the details asked by the installer and verify that the installer completes successfully. If there are errors see the section below.
* Use the link generated by the installer to create a new Zulip organization. Send a couple of messages and make sure everything is working fine.
* Submit the image in the [DigitalOcean vendor portal](https://marketplace.digitalocean.com/vendorportal).
* Keep checking the vendor portal for the status of the submission every day.
  DigitalOcean do send emails when there are any updates on the submission.
  But we have found the emails to be not super reliable in the past.

**Errors**

If there are any errors, you have two option
* Include the fix in `https://github.com/zulip/marketplace-partners`. `templates/Fabric/scripts/01-initial-setup` should be a good place to include the fix.
* Wait for the next minor release to fix the error.
